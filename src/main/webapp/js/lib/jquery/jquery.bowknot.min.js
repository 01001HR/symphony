/*
 * Copyright (C) 2010,2011, Liyuan Li
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function($){$.fn.extend({dialog:{version:"0.0.1.7",author:"lly219@gmail.com"}});var dpuuid=new Date().getTime();var PROP_NAME='dialog';var Dialog=function(){this._defaults={"styleClass":{"background":"dialog-background","panel":"dialog-panel","main":"dialog-main","footer":"dialog-footer","headerMiddle":"dialog-header-middle","headerBg":"dialog-header-bg","closeIcon":"icon-close","closeIconHover":"dialog-close-icon-hover","title":"dialog-title"}}};$.extend(Dialog.prototype,{_attach:function(target,settings){if(!target.id){this.uuid++;target.id='dp'+this.uuid}var inst=this._newInst($(target));inst.settings=$.extend({},settings||{});$.data(target,PROP_NAME,inst);this._init(target)},_newInst:function(target){var id=target[0].id.replace(/([^A-Za-z0-9_])/g,'\\\\$1');return{id:id}},_getInst:function(target){try{return $.data(target,PROP_NAME)}catch(err){throw'Missing instance data for this dialog';}},_destroyDialog:function(target){var inst=$.dialog._getInst(target);var id=inst.id;$.removeData(target,PROP_NAME);$(target).prependTo("#"+id+"Wrap").unwrap();$(target).removeAttr("style");var styleClass=this._getDefaults($.dialog._defaults,inst.settings,"styleClass");$("."+styleClass.background).remove();$("#"+id+"Dialog").remove()},_init:function(target){var inst=this._getInst(target);var id=inst.id,settings=inst.settings;var windowH=$(window).height(),windowW=$(window).width();var styleClass=this._getDefaults($.dialog._defaults,settings,"styleClass"),dialogH=settings.height?settings.height:parseInt(windowH*0.6),dialogW=settings.width?settings.width:parseInt(windowW*0.6);settings.title=settings.title?settings.title:"";settings.okText=settings.okText?settings.okText:"Ok";settings.cancelText=settings.cancelText?settings.cancelText:"Cancel";var footerHTML="",headerHTML="<div class='fn-clear "+styleClass.headerBg+"'><div class='"+styleClass.title+"'>"+settings.title+"</div><a href='javascript:void(0);' class='"+styleClass.closeIcon+"'></a></div>";if(!settings.hideFooter){footerHTML="<a href='javascript:void(0);'>"+settings.okText+"</a><a href='javascript:void(0);'>"+settings.cancelText+"</a>"}var dialogHTML="<div id='"+id+"Dialog' class='"+styleClass.panel+"' style='width: "+dialogW+"px; height: "+dialogH+"px;' onselectstart='return false;'>"+headerHTML+"<div class='"+styleClass.main+"' style='overflow: auto;height:"+(dialogH-78)+"px'><div class='"+styleClass.footer+"'>"+footerHTML+"</div></div>";var bgHTML="";if(settings.modal&&$("."+styleClass.background).length===0){var bgHeight=windowH<document.documentElement.scrollHeight?document.documentElement.scrollHeight:windowH;bgHTML="<div style='height:"+bgHeight+"px;' class='"+styleClass.background+"'></div>"}$("#"+id).wrap("<div id='"+id+"Wrap'></div>");var cloneObj=$(target).clone(true);$(target).remove();$('body').append(bgHTML+dialogHTML);$($("#"+id+"Dialog ."+styleClass.main+" div").get(0)).append(cloneObj);$(cloneObj).show();var top="",left="",$dialog=$("#"+id+"Dialog");if(settings.position){top=settings.position.top;left=settings.position.left}else{top=parseInt((windowH-dialogH)/2);left=parseInt((windowW-dialogW)/2)}$dialog.css({"top":top+"px","left":left+"px"});$("#"+id+"Dialog ."+styleClass.closeIcon).bind("click",function(){$.dialog._close(id,settings)});var $buttons=$("#"+id+"Dialog ."+styleClass.footer+" a");$($buttons.get(1)).bind("click",function(){$.dialog._close(id,settings)});$($buttons.get(0)).bind("click",function(){if(settings.ok===undefined||settings.ok()){$.dialog._close(id,settings)}});this._bindMove(id,styleClass.headerBg,dialogH,dialogW);$(window).keyup(function(event){if(event.keyCode===27){$.dialog._close(id,settings)}})},_bindMove:function(id,className){$("#"+id+"Dialog ."+className).mousedown(function(event){var _document=document;if(!event){event=window.event}var dialog=document.getElementById(id+"Dialog");var x=event.clientX-parseInt(dialog.style.left),y=event.clientY-parseInt(dialog.style.top);_document.ondragstart="return false;";_document.onselectstart="return false;";_document.onselect="document.selection.empty();";if(this.setCapture){this.setCapture()}else if(window.captureEvents){window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP)}_document.onmousemove=function(event){if(!event){event=window.event}var positionX=event.clientX-x,positionY=event.clientY-y;if(positionX<0){positionX=0}if(positionX>$(window).width()-$(dialog).width()){positionX=$(window).width()-$(dialog).width()}if(positionY<0){positionY=0}if(positionY>$(window).height()-$(dialog).height()){positionY=$(window).height()-$(dialog).height()}dialog.style.left=positionX+"px";dialog.style.top=positionY+"px"};_document.onmouseup=function(){if(this.releaseCapture){this.releaseCapture()}else if(window.captureEvents){window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP)}_document.onmousemove=null;_document.onmouseup=null;_document.ondragstart=null;_document.onselectstart=null;_document.onselect=null}})},_close:function(id,settings){if($("#"+id+"Dialog").css("display")==="none"){return}if(settings.close===undefined||settings.close()){$("#"+id+"Dialog").hide();if(settings.modal){var styleClass=this._getDefaults($.dialog._defaults,settings,"styleClass");$("."+styleClass.background).hide()}}},_closeDialog:function(target){var inst=this._getInst(target);var id=inst.id,settings=inst.settings;$.dialog._close(id,settings)},_openDialog:function(target){var inst=this._getInst(target);var id=inst.id,settings=inst.settings;$("#"+id+"Dialog").show();if(settings.modal){var styleClass=this._getDefaults($.dialog._defaults,settings,"styleClass");$("."+styleClass.background).show()}},_updateDialog:function(target,data){var inst=this._getInst(target);var id=inst.id,settings=inst.settings;var styleClass=this._getDefaults($.dialog._defaults,settings,"styleClass");$.extend(settings,data);var $dialog=$("#"+id+"Dialog");if(data.position){$dialog.css({"top":data.position.top,"left":data.position.left})}if(data.width){$dialog.width(data.width+26);$dialog.find("."+styleClass.main+" div")[0].style.width=data.width+"px";$dialog.find("."+styleClass.headerBg).width(data.width+18)}if(data.height){$dialog.find("."+styleClass.main+" div")[0].style.height=data.height+"px"}if(data.title){$dialog.find("."+styleClass.title).html(data.title)}if(data.modal!==undefined){if(data.modal){$("."+styleClass.background).show()}else{$("."+styleClass.background).hide()}}if(data.hideFooter!==undefined){if(data.hideFooter){$dialog.find("."+styleClass.footer).hide()}else{$dialog.find("."+styleClass.footer).show()}}},_getDefaults:function(defaults,settings,key){if(key==="styleClass"){if(settings.theme==="default"||settings.theme===undefined){return defaults.styleClass}settings.styleClass={};for(var styleName in defaults[key]){settings.styleClass[styleName]=settings.theme+"-"+defaults.styleClass[styleName]}}else if(key==="height"||key==="width"){if(settings[key]===null||settings[key]===undefined){return"auto"}else{return settings[key]+"px"}}else{if(settings[key]===null||settings[key]===undefined){return defaults[key]}}return settings[key]}});$.fn.dialog=function(options){var otherArgs=Array.prototype.slice.call(arguments);if(typeof options==='string'){otherArgs.shift();return $.dialog['_'+options+'Dialog'].apply($.dialog,[this[0]].concat(otherArgs))}return this.each(function(){$.dialog._attach(this,options)})};$.dialog=new Dialog();window['DP_jQuery_'+dpuuid]=$})(jQuery);
!function(e){var t=(new Date).getTime(),n="completed",a=function(){this._defaults={styleClass:{panelClass:"completed-panel",inputClass:"completed-input",ckClass:"completed-ck"},separator:","},this._settingsDataFormat={}};e.extend(a.prototype,{_attach:function(t,a){t.id||(this.uuid++,t.id="dp"+this.uuid);var s=this._newInst(e(t));s.settings=e.extend({buttonText:"选择"},a||{}),e.data(t,n,s),this._init(t)},_newInst:function(e){var t=e[0].id.replace(/([^A-Za-z0-9_])/g,"\\\\$1");return{id:t}},_getInst:function(t){try{return e.data(t,n)}catch(a){throw"Missing instance data for this completed"}},_destroyCompleted:function(){},_init:function(t){var n=this._getInst(t),a=n.id,s=n.settings;this._buildHTML(a,s),e(document).click(function(t){t.target.id!==a&&e("#"+a+"SelectedPanel").hide()}),s.onlySelect||this._buildCheckboxPanel(a,s.data)},_buildHTML:function(t,n){var a=n.height+"px",s=this._getDefaults(e.completed._defaults,n,"styleClass"),l=e("#"+t),i="";n.onlySelect||(i+="<button onclick=\"$('#"+t+"CheckboxPanel').toggle()\">"+n.buttonText+"</button>"),i+="<div id='"+t+"SelectedPanel' class='"+s.panelClass+"' style='height:"+a+";'></div><div class='none "+s.ckClass+"' id='"+t+"CheckboxPanel'><div>","object"==typeof n.data&&n.data.sort(),l.after(i).bind("keyup",{settings:n},this._keyupAction).bind("keydown",function(e){n.chinese=e.keyCode}).addClass(s.inputClass).width(l.width()-78);var o=e("#"+t+"SelectedPanel");n.tipNum=0,o.width(l.width()+2)},_keyupAction:function(t){var n=t.data.settings,a=e.completed._getCurrentWord(this,n);if(""===a.currentWord||27===t.keyCode||16===t.keyCode||16===t.keyCode)return e("#"+this.id+"SelectedPanel").hide(),n.tipNum=0,void(n.afterKeyup?n.afterKeyup(t):"");var s=e.completed._getMatchData(n.data,this.value,a.currentWord);if(38===t.keyCode&&(n.tipNum>0?n.tipNum--:n.tipNum=s.length-1),40===t.keyCode&&(n.tipNum<s.length-1?n.tipNum++:n.tipNum=0),e.completed._buildSelectedPanel(this.id,s,n,a.currentWord),13===t.keyCode&&s[n.tipNum]&&229!==n.chinese){var l=this.value;this.value=l.substring(0,a.startPos)+s[n.tipNum]+l.substring(a.endPos,l.length),e("#"+this.id+"SelectedPanel").hide(),n.chinese=void 0}38!==t.keyCode&&40!==t.keyCode&&(n.tipNum=0),n.afterKeyup?n.afterKeyup(t):""},_getCurrentWord:function(t,n){var a=e(t).val(),s=!0,l=0,i=0,o=e.completed._defaults.separator;if(""===a)return{currentWord:"",startPos:i,endPos:l};if(document.selection)try{var c=document.selection.createRange(),r=t.createTextRange();r.collapse(!0),r.select();var d=document.selection.createRange();d.setEndPoint("EndToEnd",c),n.curPos=d.text.length,c.select()}catch(u){delete u}else n.curPos=t.selectionStart;for(var h=n.curPos,p=0;p<a.length;p++)a.charAt(p)===o&&p>=h&&s&&(l=p,s=!1);s===!0&&(s=!1,l=a.length);for(var m=l;m>-1;m--)a.charAt(m)===o&&h>m&&!s&&(i=m+1,s=!0);return{currentWord:a.substring(i,l),startPos:i,endPos:l}},_getMatchData:function(t,n,a){for(var s=n.split(e.completed._defaults.separator),l=[],i=0;i<t.length;i++)if("number"==typeof t[i]&&(t[i]=t[i].toString()),t[i].toLowerCase().indexOf(a.toLowerCase())>-1){for(var o=!0,c=0;c<s.length;c++)t[i]===s[c].toString()&&t[i].toLowerCase()!==a.toLowerCase()&&(o=!1);o&&l.push(t[i])}return l},_mousemoveSelectPanel:function(t,n,a){e(t).parent().find("a").removeClass("selected"),t.className="selected";var s=e.completed._getInst(document.getElementById(a));s.settings.tipNum=n},_buildSelectedPanel:function(t,n,a,s){var l=e("#"+t+"SelectedPanel");if(0===n.length)return void l.html("").hide();a.tipNum>=n.length&&(a.tipNum=0);for(var i="",o=0;o<n.length;o++){var c="",r=n[o].replace(s,"<b>"+s+"</b>");a.tipNum===o&&(c="class='selected'"),i+="<a href='javascript:void(0);'                                         onmousemove=\"$.completed._mousemoveSelectPanel(this, "+o+", '"+t+"');\"                                        "+c+">"+r+"</a>"}l.html(i).show();var d=e("#"+t+"SelectedPanel a.selected");d.position().top+l.scrollTop()>50-d.height()&&l.scrollTop(d.position().top+l.scrollTop()+d.height()-50),d.position().top<0&&l.scrollTop(l.scrollTop-d.height()),e("#"+t+"SelectedPanel a").click(function(){var n=document.getElementById(t),s=e.completed._getCurrentWord(document.getElementById(t),a),l=e.completed._getMatchData(a.data,n.value,s.currentWord),i=n.value;n.value=i.substring(0,s.startPos)+l[a.tipNum]+i.substring(s.endPos,i.length),a.tipNum=0,e(n).focus(),a.afterSelected?a.afterSelected(e(this)):""})},_buildCheckboxPanel:function(t,n){for(var a="",s=e("#"+t),l=0;l<n.length;l++)a+="<span>"+n[l]+"</span>";e("#"+t+"CheckboxPanel").html(a+"<div class='clear'></div>"),e("#"+t+"CheckboxPanel span").click(function(){var e=s.val(),t=this.innerHTML;if("selected"===this.className){this.className="";var n=e.substr(e.indexOf(t)+t.length,1);t===e||","!==n?s.val(e.replace(t,"")):s.val(e.replace(t+",",""))}else this.className="selected",""===e.replace(/\s/g,"")||","===e.substr(e.length-1,1)?s.val(e+t):s.val(e+","+t)}),this._matchChecked(t),s.blur(function(){e.completed._matchChecked(t)})},_matchChecked:function(t){var n=e("#"+t).val().split(",");e("#"+t+"CheckboxPanel span").removeClass().each(function(){for(var e=0;e<n.length;e++)this.innerHTML===n[e]&&(this.className="selected")})},_updateDataCompleted:function(t,n,a){var s=this._getInst(t),l=s.id,i=s.settings;i.data=a,e.completed._buildSelectedPanel(l,a,i,"2011")},_getDefaults:function(e,t,n){if("styleClass"===n){if("default"===t.theme||void 0===t.theme)return e.styleClass;t.styleClass={};for(var a in e[n])t.styleClass[a]=t.theme+"-"+e.styleClass[a]}else{if("height"===n||"width"===n)return null===t[n]||void 0===t[n]?"auto":t[n]+"px";if(null===t[n]||void 0===t[n])return e[n]}return t[n]}}),e.fn.completed=function(t){var n=Array.prototype.slice.call(arguments);return this.each(function(){"string"==typeof t?e.completed["_"+t+"Completed"].apply(e.completed,[this].concat(n)):e.completed._attach(this,t)})},e.completed=new a,window["DP_jQuery_"+t]=e}(jQuery);