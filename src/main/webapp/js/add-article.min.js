/*
 * Copyright (c) 2012-2015, b3log.org
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var AddArticle={editor:undefined,rewardEditor:undefined,add:function(id){var isError=false;if(this.editor.getValue().length<4||this.editor.getValue().length>1048576){$("#articleContentTip").addClass("tip-error").text(Label.articleContentErrorLabel)}else{isError=true;$("#articleContentTip").removeClass("tip-error").text("")}if(Validate.goValidate([{id:"articleTitle",type:256,msg:Label.articleTitleErrorLabel},{id:"articleTags",type:"tags",msg:Label.articleTagsErrorLabel}])&&isError){var requestJSONObject={articleTitle:$("#articleTitle").val().replace(/(^\s*)|(\s*$)/g,""),articleContent:this.editor.getValue(),articleTags:$("#articleTags").val().replace(/(^\s*)|(\s*$)/g,""),syncWithSymphonyClient:$("#syncWithSymphonyClient").prop("checked"),articleCommentable:$("#articleCommentable").prop("checked"),articleType:$("#articleType").prop("checked")?1:0,articleRewardContent:this.rewardEditor.getValue(),articleRewardPoint:$("#articleRewardPoint").val().replace(/(^\s*)|(\s*$)/g,"")},url="/article",type="POST";if(id){url=url+"/"+id;type="PUT"}$.ajax({url:url,type:type,cache:false,data:JSON.stringify(requestJSONObject),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3")},success:function(result,textStatus){$(".form button.red").removeAttr("disabled").css("opacity","1");if(result.sc){window.location="/member/"+Label.userName}else{$("#addArticleTip").addClass("tip-error").text(result.msg).css({"border-left":"1px solid #E2A0A0",top:"-35px",width:"985px"})}},complete:function(){$(".form button.red").removeAttr("disabled").css("opacity","1")}})}},init:function(){Util.initCodeMirror();AddArticle.editor=CodeMirror.fromTextArea(document.getElementById("articleContent"),{mode:"markdown",dragDrop:false,extraKeys:{"'@'":"autocompleteUserName","Ctrl-/":"autocompleteEmoji",F11:function(cm){cm.setOption("fullScreen",!cm.getOption("fullScreen"))}}});AddArticle.editor.on("keydown",function(cm,evt){if(8===evt.keyCode){var cursor=cm.getCursor();var token=cm.getTokenAt(cursor);if(" "!==token.string){return}var preCursor=CodeMirror.Pos(cursor.line,cursor.ch-1);token=cm.getTokenAt(preCursor);if(Util.startsWith(token.string,"@")){cm.replaceRange("",CodeMirror.Pos(cursor.line,token.start),CodeMirror.Pos(cursor.line,token.end))}}});AddArticle.editor.on("changes",function(cm){if(cm.getValue().replace(/(^\s*)|(\s*$)/g,"")!==""){$(".form .green").show()}else{$(".form .green").hide()}});$("#articleTitle, #articleTags, #articleRewardPoint").keypress(function(event){if(13===event.keyCode){AddArticle.add()}});$("#preview").dialog({modal:true,hideFooter:true});var readOnly=false;if(0<$("#articleRewardPoint").val().replace(/(^\s*)|(\s*$)/g,"")){readOnly="nocursor"}AddArticle.rewardEditor=CodeMirror.fromTextArea(document.getElementById("articleRewardContent"),{mode:"markdown",dragDrop:false,readOnly:readOnly,extraKeys:{"'@'":"autocompleteUserName","Ctrl-/":"autocompleteEmoji",F11:function(cm){cm.setOption("fullScreen",!cm.getOption("fullScreen"))}}});AddArticle.rewardEditor.on("keydown",function(cm,evt){if(8===evt.keyCode){var cursor=cm.getCursor();var token=cm.getTokenAt(cursor);if(" "!==token.string){return}var preCursor=CodeMirror.Pos(cursor.line,cursor.ch-1);token=cm.getTokenAt(preCursor);if(Util.startsWith(token.string,"@")){cm.replaceRange("",CodeMirror.Pos(cursor.line,token.start),CodeMirror.Pos(cursor.line,token.end))}}});$("#articleRewardContent").next().height(100)},_initFileUpload:function(){$("#fileupload").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:1024*1024,multipart:true,pasteZone:$(".CodeMirror"),dropZone:$(".CodeMirror"),url:"http://upload.qiniu.com/",formData:function(form){var data=form.serializeArray();data.push({name:"token",value:"${qiniuUploadToken}"});return data},submit:function(e,data){var cursor=AddArticle.editor.getCursor();AddArticle.editor.replaceRange("${uploadingLabel}",cursor,cursor)},done:function(e,data){var qiniuKey=data.result.key;if(!qiniuKey){alert("Upload error");return}var cursor=AddArticle.editor.getCursor();AddArticle.editor.replaceRange("![ ](${qiniuDomain}/"+qiniuKey+") ",CodeMirror.Pos(cursor.line,cursor.ch-"${uploadingLabel}".length),cursor)},fail:function(e,data){alert("Upload error: "+data.errorThrown);var cursor=AddArticle.editor.getCursor();AddArticle.editor.replaceRange("",CodeMirror.Pos(cursor.line,cursor.ch-"${uploadingLabel}".length),cursor)}}).on("fileuploadprocessalways",function(e,data){var currentFile=data.files[data.index];if(data.files.error&&currentFile.error){alert(currentFile.error)}})},preview:function(){var it=this;$.ajax({url:"/markdown",type:"POST",cache:false,data:{markdownText:it.editor.getValue()},success:function(result,textStatus){$("#preview").dialog("open");$("#preview").html(result.html)}})},grammar:function(){var $grammar=$(".grammar"),$codemirror=$(".CodeMirror");if($("#articleTitle").width()<500){$grammar.toggle();return}if($codemirror.width()>900){$grammar.show();$codemirror.width(750)}else{$grammar.hide();$codemirror.width(996)}}};AddArticle.init();